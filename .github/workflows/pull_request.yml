name: Pull Request and Merge

on:
  pull_request:
    branches:
      - main

jobs:
  merge_job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.TOKEN }}  # Use the default TOKEN for public repositories

      - name: Set up PHP environment (modify according to your Laravel project setup)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Install Laravel dependencies
        run: |
          composer install
          cp .env.example .env
          php artisan key:generate
          php artisan migrate:fresh

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.TOKEN }}  # Use the default TOKEN for public repositories
          commit-message: 'Auto-generated PR'
          title: ${{ steps.pr_info.outputs.title }}
          body: ${{ steps.pr_info.outputs.body }}
          branch: 'development'
          # Additional options can be used as required.

      - name: Wait for PR checks to pass
        uses: thollander/actions-wait-for-checks@v1
        with:
          github-token: ${{ secrets.TOKEN }}  # Use the default TOKEN for public repositories
          check-names: 'continuous-integration/*'  # You may need to adjust this based on your actual check names.

      - name: Merge PR into main
        uses: pascalgn/automerge-action@v0.13.0
        with:
          github-token: ${{ secrets.TOKEN }}  # Use the default TOKEN for public repositories
          method: 'squash'  # Change to 'merge' or 'rebase' if needed.

